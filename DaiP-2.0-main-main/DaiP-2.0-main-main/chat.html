<!DOCTYPE html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DaiPæ™ºèƒ½èŠå¤©å®¤ - èŠå¤©ä¸­</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Orbitron', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a2332 50%, #0d1b2a 100%);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        
        /* èƒŒæ™¯éœ“è™¹ç½‘æ ¼æ•ˆæœ */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                linear-gradient(90deg, rgba(17, 255, 238, 0.05) 1px, transparent 1px),
                linear-gradient(rgba(17, 255, 238, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridMove 20s linear infinite;
            z-index: -1;
        }
        
        @keyframes gridMove {
            0% { background-position: 0 0; }
            100% { background-position: 50px 50px; }
        }
        
        .header {
            background: linear-gradient(135deg, #0a0e27 0%, #1a2332 100%);
            color: #00ffcc;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(17, 255, 238, 0.2);
            border-bottom: 1px solid rgba(17, 255, 238, 0.2);
        }
        
        .header h1 {
            font-size: 22px;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(17, 255, 238, 0.8),
                        0 0 20px rgba(17, 255, 238, 0.5);
        }
        
        .header .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .header .nickname {
            font-weight: 600;
            background: rgba(17, 255, 238, 0.1);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            border: 1px solid rgba(17, 255, 238, 0.3);
            text-shadow: 0 0 5px rgba(17, 255, 238, 0.5);
        }
        
        .header button {
            background-color: rgba(17, 255, 238, 0.1);
            color: #00ffcc;
            border: 1px solid rgba(17, 255, 238, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(17, 255, 238, 0.2);
            font-family: inherit;
        }
        
        .header button:hover {
            background-color: rgba(17, 255, 238, 0.2);
            box-shadow: 0 0 15px rgba(17, 255, 238, 0.4);
        }
        
        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
            transition: background 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
        }
        
        /* å¤©æ°”èƒŒæ™¯æ•ˆæœ */
        .main-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            opacity: 0.3;
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: -1;
        }
        
        /* æ™´å¤©èƒŒæ™¯ */
        .main-container.clear::before {
            background-image: url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80');
        }
        
        /* å¤šäº‘èƒŒæ™¯ */
        .main-container.clouds::before {
            background-image: url('https://images.unsplash.com/photo-1535137830170-1587b043c509?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1974&q=80');
        }
        
        /* é›¨å¤©èƒŒæ™¯ */
        .main-container.rain::before {
            background-image: url('https://images.unsplash.com/photo-1508873696983-2dfd5898f08b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1974&q=80');
        }
        
        /* é›ªå¤©èƒŒæ™¯ */
        .main-container.snow::before {
            background-image: url('https://images.unsplash.com/photo-1516280440614-37939bbacd81?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1974&q=80');
        }
        
        /* é›·æš´èƒŒæ™¯ */
        .main-container.thunderstorm::before {
            background-image: url('https://images.unsplash.com/photo-1537791825246-1fcf81d692f8?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1974&q=80');
        }
        
        /* é›¾å¤©èƒŒæ™¯ */
        .main-container.mist::before {
            background-image: url('https://images.unsplash.com/photo-1540575467063-178a50c2df87?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1974&q=80');
        }
        
        /* è‡ªå®šä¹‰å¤©æ°”èƒŒæ™¯ç±» - ä½¿ç”¨åœºæ™¯å›¾ç‰‡ */
        .main-container.bg-sunny {
            background-color: transparent;
            background-image: url('/static/images/weather/sunny.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .main-container.bg-cloudy {
            background-color: transparent;
            background-image: url('/static/images/weather/cloudy.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .main-container.bg-overcast {
            background-color: transparent;
            background-image: url('https://picsum.photos/id/111/1920/1080');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .main-container.bg-rainy {
            background-color: transparent;
            background-image: url('/static/images/weather/rainy.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .main-container.bg-snowy {
            background-color: transparent;
            background-image: url('https://picsum.photos/id/153/1920/1080');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .main-container.bg-breeze {
            background-color: transparent;
            background-image: url('/static/images/weather/breeze.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .main-container.bg-mist {
            background-color: transparent;
            background-image: url('https://picsum.photos/id/1056/1920/1080');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .main-container.bg-haze {
            background-color: transparent;
            background-image: url('https://picsum.photos/id/1061/1920/1080');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        /* æ¶ˆæ¯å…ƒç´ çš„å¤©æ°”èƒŒæ™¯æ ·å¼ */
        .message.bg-sunny {
            background-color: #FFD700; /* æµ…æ©™è‰²æ¸…çˆ½èƒŒæ™¯ */
            border-radius: 8px;
            padding: 10px;
        }
        
        .message.bg-cloudy {
            background-color: #D3D3D3; /* æµ…ç°è‰²èƒŒæ™¯ */
            border-radius: 8px;
            padding: 10px;
        }
        
        .message.bg-overcast {
            background-color: #D3D3D3; /* æµ…ç°è‰²èƒŒæ™¯ */
            color: #333; /* æµ…ç°è‰²èƒŒæ™¯ä¸‹æ–‡å­—è®¾ä¸ºæ·±ç°è‰² */
            border-radius: 8px;
            padding: 10px;
        }
        
        .message.bg-rainy {
            background-color: #87CEEB; /* æµ…è“è‰²å¸¦ç»†å¾®é›¨æ»´çº¹ç†èƒŒæ™¯ */
            background-image: radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            background-size: 20px 20px;
            border-radius: 8px;
            padding: 10px;
        }
        
        .message.bg-snowy {
            background-color: #F0F8FF; /* æµ…ç™½è‰²å¸¦é›ªèŠ±çº¹ç†èƒŒæ™¯ */
            background-image: radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.2) 0%, transparent 50%);
            background-size: 25px 25px;
            border-radius: 8px;
            padding: 10px;
        }
        
        /* å¤©æ°”å¡ç‰‡æ ·å¼ */
        .weather-card {
            background-color: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 300px;
            margin: 10px auto;
            animation: fade-in 0.5s ease;
        }
        
        .weather-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .weather-card-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .weather-main {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .weather-temp {
            font-size: 32px;
            font-weight: 700;
            color: #333;
        }
        
        .weather-desc {
            font-size: 18px;
            color: #666;
        }
        
        .weather-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .weather-item {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .weather-label {
            color: #999;
        }
        
        .weather-value {
            color: #333;
            font-weight: 500;
        }
        
        .weather-error {
            background-color: #fff3f3;
            border: 1px solid #ffcccc;
            color: #ff6666;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            margin: 10px auto;
            max-width: 300px;
            animation: fade-in 0.5s ease;
        }
        
        /* æ¢å¤é»˜è®¤èƒŒæ™¯æŒ‰é’® */
        .reset-background-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid #ddd;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
            z-index: 100;
        }
        
        .reset-background-btn:hover {
            background-color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(13, 27, 42, 0.85);
            backdrop-filter: blur(10px);
            margin: 20px;
            border-radius: 12px;
            box-shadow: 
                0 0 30px rgba(17, 255, 238, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            overflow: hidden;
            border: 1px solid rgba(17, 255, 238, 0.2);
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            transition: background 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* èŠå¤©æ¶ˆæ¯åŒºåŸŸçš„å¤©æ°”èƒŒæ™¯æ ·å¼ - ä¸æ•´ä½“èƒŒæ™¯ç»Ÿä¸€æ ·å¼ */
        .chat-messages.bg-sunny {
            background-color: transparent;
            background-image: url('https://picsum.photos/id/119/1920/1080');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            backdrop-filter: blur(5px);
        }
        
        .chat-messages.bg-cloudy {
            background-color: transparent;
            background-image: url('https://picsum.photos/id/129/1920/1080');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            backdrop-filter: blur(5px);
        }
        
        .chat-messages.bg-overcast {
            background-color: transparent;
            background-image: url('https://picsum.photos/id/111/1920/1080');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            backdrop-filter: blur(5px);
        }
        
        .chat-messages.bg-rainy {
            background-color: transparent;
            background-image: url('https://picsum.photos/id/1036/1920/1080');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            backdrop-filter: blur(5px);
        }
        
        .chat-messages.bg-snowy {
            background-color: transparent;
            background-image: url('https://picsum.photos/id/153/1920/1080');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            backdrop-filter: blur(5px);
        }
        
        .chat-messages.bg-breeze {
            background-color: transparent;
            background-image: url('https://picsum.photos/id/1018/1920/1080');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            backdrop-filter: blur(5px);
        }
        
        .chat-messages.bg-mist {
            background-color: transparent;
            background-image: url('https://picsum.photos/id/1056/1920/1080');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            backdrop-filter: blur(5px);
        }
        
        .chat-messages.bg-haze {
            background-color: transparent;
            background-image: url('https://picsum.photos/id/1061/1920/1080');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            backdrop-filter: blur(5px);
        }
        
        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            animation: fade-in 0.3s ease;
            position: relative;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.own {
            align-self: flex-end;
            background: linear-gradient(135deg, #00ffcc 0%, #0099cc 100%);
            color: #0a0e27;
        }
        
        .message.other {
            align-self: flex-start;
            background: rgba(26, 35, 50, 0.9);
            color: #ffffff;
            border: 1px solid rgba(17, 255, 238, 0.2);
        }
        
        .message.system {
            align-self: center;
            background: rgba(17, 255, 238, 0.1);
            color: #00ffcc;
            font-size: 14px;
            padding: 8px 12px;
            border: 1px solid rgba(17, 255, 238, 0.3);
        }
        
        .message .metadata {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 4px;
        }
        
        .message .content {
            line-height: 1.4;
        }
        
        .message .content .mention {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .message.other .content .mention {
            background-color: rgba(17, 255, 238, 0.3);
            color: #00ffcc;
        }
        
        .message.movie .movie-player {
            margin-top: 10px;
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
        }
        
        /* å·å°å†œAIåŠ©æ‰‹æ ·å¼ */
        .message.ai-assistant {
            align-self: flex-start;
            background: rgba(17, 255, 238, 0.15);
            color: #00ffcc;
            position: relative;
            padding-left: 36px;
            border: 1px solid rgba(17, 255, 238, 0.4);
        }
        
        .message.ai-assistant .avatar {
            position: absolute;
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #00ffcc 0%, #0099cc 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            z-index: 1;
            box-shadow: 0 0 15px rgba(17, 255, 238, 0.6);
            color: #0a0e27;
        }
        
        .message.ai-assistant .metadata {
            color: #00ffcc;
        }
        
        .message.ai-assistant .content {
            font-style: italic;
        }
        
        .input-container {
            padding: 20px;
            background: rgba(26, 35, 50, 0.8);
            border-top: 1px solid rgba(17, 255, 238, 0.2);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .emoji-picker {
            display: none;
            background-color: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-height: 150px;
            overflow-y: auto;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
        }
        
        .emoji-picker.visible {
            display: grid;
        }
        
        .emoji {
            font-size: 20px;
            text-align: center;
            padding: 5px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        
        .emoji:hover {
            background-color: #f1f1f1;
        }
        
        /* @åŠŸèƒ½é€‰é¡¹å¼¹çª—æ ·å¼ */
        .at-options {
            display: none;
            position: absolute;
            background-color: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 200px;
        }
        
        .at-options.visible {
            display: block;
        }
        
        .at-option {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        
        .at-option:hover {
            background-color: #f1f1f1;
        }
        
        .at-option i {
            margin-right: 8px;
        }
        
        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .message-input {
            flex: 1;
            padding: 12px 16px;
            background: rgba(13, 27, 42, 0.9);
            border: 2px solid rgba(17, 255, 238, 0.2);
            border-radius: 24px;
            font-size: 16px;
            resize: none;
            max-height: 120px;
            overflow-y: auto;
            transition: all 0.3s ease;
            color: #ffffff;
            font-family: inherit;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .message-input:focus {
            outline: none;
            border-color: #00ffcc;
            box-shadow: 
                0 0 15px rgba(17, 255, 238, 0.5),
                inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .input-actions {
            display: flex;
            gap: 8px;
        }
        
        .input-actions button {
            background: linear-gradient(135deg, #00ffcc 0%, #0099cc 100%);
            color: #0a0e27;
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(17, 255, 238, 0.4);
        }
        
        .input-actions button:hover {
            background: linear-gradient(135deg, #0099cc 0%, #00ffcc 100%);
            box-shadow: 0 6px 20px rgba(17, 255, 238, 0.6);
        }
        
        .input-actions .emoji-btn {
            background: rgba(17, 255, 238, 0.1);
            color: #00ffcc;
            padding: 12px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(17, 255, 238, 0.3);
            transition: all 0.3s ease;
        }
        
        .input-actions .emoji-btn:hover {
            background: rgba(17, 255, 238, 0.2);
            box-shadow: 0 0 15px rgba(17, 255, 238, 0.5);
        }
        
        .users-sidebar {
            width: 280px;
            background: rgba(26, 35, 50, 0.85);
            backdrop-filter: blur(10px);
            border-left: 1px solid rgba(17, 255, 238, 0.2);
            display: flex;
            flex-direction: column;
            box-shadow: -2px 0 20px rgba(17, 255, 238, 0.1);
            border-left: 1px solid rgba(17, 255, 238, 0.2);
        }
        
        .users-sidebar h3 {
            padding: 20px;
            font-size: 16px;
            font-weight: 700;
            border-bottom: 1px solid rgba(17, 255, 238, 0.2);
            color: #00ffcc;
            text-shadow: 0 0 5px rgba(17, 255, 238, 0.5);
        }
        
        .users-list {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
        }
        
        .user-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 5px;
            transition: all 0.2s ease;
            background: rgba(13, 27, 42, 0.6);
            border: 1px solid rgba(17, 255, 238, 0.1);
        }
        
        .user-item:hover {
            background: rgba(17, 255, 238, 0.1);
            border-color: rgba(17, 255, 238, 0.3);
        }
        
        .user-item.you {
            background: rgba(17, 255, 238, 0.15);
            border-color: rgba(17, 255, 238, 0.4);
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00ffcc 0%, #0099cc 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #0a0e27;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 0 15px rgba(17, 255, 238, 0.5);
        }
        
        .user-name {
            font-weight: 600;
            color: #ffffff;
        }
        
        .user-item.you .user-name {
            color: #00ffcc;
            text-shadow: 0 0 5px rgba(17, 255, 238, 0.8);
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: auto;
        }
        
        .status-indicator.online {
            background-color: #4caf50;
        }
        
        .status-indicator.offline {
            background-color: #ccc;
        }
        
        .tip {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 14px;
            animation: slide-in 0.3s ease;
        }
        
        /* å¤©æ°”ä¿¡æ¯æ ·å¼ */
        .weather-info {
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: 8px;
            margin: 5px 0;
        }
        
        /* éŸ³ä¹æ’­æ”¾å™¨æ ·å¼ */
        .music-player {
            background: linear-gradient(135deg, #00ffcc 0%, #0099cc 100%);
            color: #0a0e27;
            padding: 20px;
            border-radius: 16px;
            margin: 15px 0;
            box-shadow: 0 8px 25px rgba(17, 255, 238, 0.4);
            transition: all 0.3s ease;
        }
        
        .music-player:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(17, 255, 238, 0.6);
        }
        
        .music-info {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .music-info.error {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }
        
        .music-info h3 {
            margin: 0 0 8px 0;
            font-size: 20px;
            font-weight: 700;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .music-info .artist {
            margin: 0 0 20px 0;
            font-size: 14px;
            opacity: 0.9;
            font-weight: 400;
            color: white;
        }
        
        .music-cover {
            margin: 20px auto;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .cover-placeholder {
            font-size: 60px;
            opacity: 0.7;
        }
        
        .music-progress {
            margin: 20px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .progress-bar:hover {
            height: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 4px;
            width: 0%;
            transition: width 0.1s linear;
        }
        
        .progress-time {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 8px;
        }
        
        .music-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .music-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 80px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .music-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .play-btn {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .play-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }
        
        .stop-btn {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .stop-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }
        
        /* æ­Œè¯æ˜¾ç¤ºæ ·å¼ - æš‚æ—¶éšè— */
        .music-lyrics {
            display: none;
        }
        
        .error-message {
            padding: 20px;
            font-size: 14px;
            opacity: 0.9;
            text-align: center;
            color: white;
        }
        
        .music-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: white;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            margin-left: auto;
        }
        
        .music-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .music-header {
            display: block;
            position: relative;
            margin-bottom: 20px;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .music-player {
                margin: 10px;
                padding: 15px;
                border-radius: 12px;
            }
            
            .music-info h3 {
                font-size: 18px;
            }
            
            .music-cover {
                width: 120px;
                height: 120px;
                margin: 15px auto;
            }
            
            .cover-placeholder {
                font-size: 50px;
            }
            
            .music-controls {
                gap: 10px;
                margin-top: 15px;
            }
            
            .music-btn {
                padding: 10px 15px;
                font-size: 13px;
                min-width: 70px;
            }
        }
        
        @media (max-width: 480px) {
            .music-player {
                padding: 12px;
            }
            
            .music-info h3 {
                font-size: 16px;
            }
            
            .music-info .artist {
                font-size: 13px;
            }
            
            .music-cover {
                width: 100px;
                height: 100px;
            }
            
            .cover-placeholder {
                font-size: 40px;
            }
            
            .music-controls {
                gap: 8px;
            }
            
            .music-btn {
                padding: 8px 12px;
                font-size: 12px;
                min-width: 60px;
            }
        }
        
        /* æ–°é—»å¡ç‰‡æ ·å¼ */
        .news-card {
            background-color: rgba(255, 243, 224, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            margin-bottom: 15px;
        }
        
        .news-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .news-meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 15px;
            display: flex;
            gap: 15px;
        }
        
        .news-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .news-image {
            width: 100%;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .news-img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .news-summary {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
        }
        
        .news-footer {
            margin-top: 15px;
            text-align: right;
        }
        
        .news-link {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
        }
        
        .news-link:hover {
            text-decoration: underline;
        }
        
        /* æ–°é—»åˆ—è¡¨æ ·å¼ */
        .news-list-container {
            background-color: rgba(255, 243, 224, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            margin-bottom: 15px;
        }
        
        .news-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .news-list-item {
            display: flex;
            gap: 15px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .news-list-item:last-child {
            border-bottom: none;
        }
        
        .news-list-image {
            width: 120px;
            height: 80px;
            border-radius: 6px;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .news-list-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .news-list-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .news-list-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        
        .news-list-meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            display: flex;
            gap: 15px;
        }
        
        .news-list-summary {
            font-size: 13px;
            line-height: 1.5;
            color: #555;
            margin: 0;
        }
        
        /* æ–°é—»é”™è¯¯æç¤ºæ ·å¼ */
        .news-error {
            background-color: rgba(255, 235, 238, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            color: #c62828;
            text-align: center;
            margin-bottom: 15px;
        }
        
        /* æ–°é—»ä¿¡æ¯æç¤ºæ ·å¼ */
        .news-info {
            background-color: rgba(227, 242, 253, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            color: #1565c0;
            text-align: center;
            margin-bottom: 15px;
        }
        

        
        /* ç”¨æˆ·èµ„æ–™æŒ‰é’® */
        .profile-btn {
            background-color: #667eea;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .profile-btn:hover {
            background-color: #5a6fd8;
        }
        
        @keyframes slide-in {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .chat-container {
                margin: 10px;
                height: calc(100vh - 120px);
            }
            
            .users-sidebar {
                position: fixed;
                top: 70px;
                right: -280px;
                height: calc(100vh - 70px);
                transition: right 0.3s ease;
                z-index: 1000;
            }
            
            .users-sidebar.visible {
                right: 0;
            }
            
            .toggle-sidebar {
                display: block !important;
            }
            
            .message {
                max-width: 85%;
            }
        }
        
        .toggle-sidebar {
            display: none;
            background-color: #667eea;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 999;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>DaiPæ™ºèƒ½èŠå¤©å®¤</h1>
        <div class="user-info">
            <span class="nickname">{{ nickname }}</span>
            <button id="logoutBtn">é€€å‡º</button>
        </div>
    </div>
    
    <div class="main-container" id="mainContainer">
        <button class="reset-background-btn" id="resetBackgroundBtn" title="æ¢å¤é»˜è®¤èƒŒæ™¯">ğŸ–¼ï¸</button>
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <!-- èŠå¤©æ¶ˆæ¯ä¼šåœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
            </div>
            
            <div class="input-container">
                <div class="emoji-picker" id="emojiPicker">
                    <!-- Emoji will be dynamically added -->
                </div>
                
                <div class="input-wrapper" style="position: relative;">
                    <textarea class="message-input" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯... æ”¯æŒ@å¤©æ°”ã€@æ–°é—»ã€@å¬éŸ³ä¹åŠŸèƒ½"></textarea>
                    <div class="at-options" id="atOptions">
                        <div class="at-option" data-action="å¤©æ°”">ğŸŒ¤ï¸ @å¤©æ°”</div>
                        <div class="at-option" data-action="æ–°é—»">ğŸ“° @æ–°é—»</div>
                        <div class="at-option" data-action="å¬éŸ³ä¹">ğŸµ @å¬éŸ³ä¹</div>
                    </div>
                    <div class="input-actions">
                        <button class="emoji-btn" id="toggleEmojiBtn">ğŸ˜Š</button>
                        <button id="sendBtn">å‘é€</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="users-sidebar" id="usersSidebar">
            <h3>åœ¨çº¿ç”¨æˆ· (<span id="onlineUserCount">0</span>)</h3>
            <div class="users-list" id="usersList">
                <!-- ç”¨æˆ·åˆ—è¡¨ä¼šåœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
            </div>
        </div>
    </div>
    
    <button class="toggle-sidebar" id="toggleSidebarBtn">ğŸ‘¥</button>
    
    <!-- Socket.IO å®¢æˆ·ç«¯åº“ -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const nickname = '{{ nickname }}';
            const username = '{{ username }}';
            const server = '{{ server }}';
            let socket = null;
            
            // éŸ³ä¹æ’­æ”¾çŠ¶æ€å˜é‡ï¼Œæå‡åˆ°é¡¶å±‚ä½œç”¨åŸŸ
            let isPlaying = false;
            let currentAudioElement = null;
            // éŸ³ä¹å¡ç‰‡æ˜¾ç¤ºæ§åˆ¶æ ‡å¿—
            let showMusicCard = false;
            
            // DOMå…ƒç´ 
            const chatMessages = document.getElementById('chatMessages');
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const emojiPicker = document.getElementById('emojiPicker');
            const toggleEmojiBtn = document.getElementById('toggleEmojiBtn');
            const usersList = document.getElementById('usersList');
            const usersSidebar = document.getElementById('usersSidebar');
            const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
            const atOptions = document.getElementById('atOptions');
            let lastAtPosition = -1;
            
            // åˆå§‹åŒ–WebSocketè¿æ¥
            function initWebSocket() {
                // åˆå§‹åŒ–Socket.IO
                socket = io('{{ server }}', { transports: ['websocket'] });
                
                // è¿æ¥äº‹ä»¶
                socket.on('connect', function() {
                    console.log('Connected to server');
                    // å‘é€åŠ å…¥äº‹ä»¶
                    socket.emit('join', { username: username, nickname: nickname });
                    // è¯·æ±‚å†å²æ¶ˆæ¯
                    socket.emit('request_history');
                });
                
                // æ–­å¼€è¿æ¥äº‹ä»¶
                socket.on('disconnect', function() {
                    console.log('Disconnected from server');
                    showTip('è¿æ¥å·²æ–­å¼€ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                });
                
                // æ¥æ”¶æ¶ˆæ¯äº‹ä»¶
                socket.on('receive_message', function(data) {
                    addMessage(data);
                });
            
                // åŠ è½½å†å²æ¶ˆæ¯
                socket.on('load_history', function(data) {
                    const messages = data.messages;
                    if (messages && messages.length > 0) {
                        // æ¸…ç©ºç°æœ‰æ¶ˆæ¯
                        chatMessages.innerHTML = '';
                        
                        // åŠ è½½å†å²æ¶ˆæ¯
                        messages.forEach(message => {
                            addMessage(message);
                        });
                    }
                });
                
                // ç”¨æˆ·åŠ å…¥äº‹ä»¶
                socket.on('user_joined', function(data) {
                    updateUsersList(data.users);
                    if (data.nickname !== nickname) {
                        addSystemMessage(`${data.nickname} åŠ å…¥äº†èŠå¤©å®¤`);
                    }
                });
                
                // ç”¨æˆ·ç¦»å¼€äº‹ä»¶
                socket.on('user_left', function(data) {
                    updateUsersList(data.users);
                    addSystemMessage(`${data.nickname} ç¦»å¼€äº†èŠå¤©å®¤`);
                });
                
                // ç”¨æˆ·çŠ¶æ€å˜åŒ–äº‹ä»¶
                socket.on('user_status_change', function(data) {
                    // æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
                    updateUsersList(data.users);
                    // æ˜¾ç¤ºçŠ¶æ€å˜åŒ–æ¶ˆæ¯
                    addSystemMessage(`${data.nickname} ${data.status === 'online' ? 'ä¸Šçº¿' : 'ä¸‹çº¿'}`);
                });
                
                // å¤©æ°”æ›´æ–°äº‹ä»¶
                socket.on('weather_update', function(data) {
                    // æ›´æ–°èŠå¤©èƒŒæ™¯
                    if (data.background_class) {
                        const mainContainer = document.querySelector('.main-container');
                        const backgroundClass = data.background_class;
                        
                        // ç§»é™¤æ‰€æœ‰å¤©æ°”èƒŒæ™¯ç±»
                    mainContainer.classList.remove('bg-sunny', 'bg-cloudy', 'bg-overcast', 'bg-rainy', 'bg-snowy', 'bg-breeze', 'bg-mist', 'bg-haze');
                    chatMessages.classList.remove('bg-sunny', 'bg-cloudy', 'bg-overcast', 'bg-rainy', 'bg-snowy', 'bg-breeze', 'bg-mist', 'bg-haze');
                        
                        // æ·»åŠ æ–°çš„å¤©æ°”èƒŒæ™¯ç±»
                        mainContainer.classList.add(backgroundClass);
                        chatMessages.classList.add(backgroundClass);
                    }
                });
                
                // ä¿å­˜å½“å‰éŸ³ä¹ä¿¡æ¯ï¼Œç”¨äºæ¯”è¾ƒæ˜¯å¦éœ€è¦æ›´æ–°
                let currentMusicInfo = {
                    url: null,
                    title: null
                };
                
                // éŸ³ä¹æ›´æ–°äº‹ä»¶
                socket.on('music_update', function(data) {
                    // æ£€æŸ¥éŸ³ä¹æ•°æ®æ˜¯å¦å‘ç”Ÿäº†å®é™…å˜åŒ–ï¼Œåªæœ‰å˜åŒ–æ—¶æ‰æ›´æ–°æ’­æ”¾å™¨
                    const musicChanged = data.url !== currentMusicInfo.url || data.title !== currentMusicInfo.title;
                    
                    if ((musicChanged || data.error) && showMusicCard) {
                        // åªæœ‰åœ¨éŸ³ä¹å‘ç”Ÿå˜åŒ–æˆ–æœ‰é”™è¯¯ä¿¡æ¯ï¼Œä¸”showMusicCardä¸ºtrueæ—¶æ‰æ›´æ–°æ’­æ”¾å™¨
                        updateMusicPlayer(data);
                        // æ›´æ–°å½“å‰éŸ³ä¹ä¿¡æ¯
                        currentMusicInfo = {
                            url: data.url,
                            title: data.title
                        };
                    }
                    // å¦åˆ™å¿½ç•¥è¯¥äº‹ä»¶ï¼Œé¿å…ä¸å¿…è¦çš„æ’­æ”¾å™¨é‡å»ºå’Œæ’­æ”¾ä¸­æ–­
                });
                
                // æ¬¢è¿æ¶ˆæ¯äº‹ä»¶
                socket.on('welcome_message', function(data) {
                    addSystemMessage(data.message);
                });
            }
            
            // æ¢å¤é»˜è®¤èƒŒæ™¯åŠŸèƒ½
            document.getElementById('resetBackgroundBtn').addEventListener('click', function() {
                const mainContainer = document.getElementById('mainContainer');
                // ç§»é™¤æ‰€æœ‰å¤©æ°”èƒŒæ™¯ç±»
            mainContainer.classList.remove('bg-sunny', 'bg-cloudy', 'bg-overcast', 'bg-rainy', 'bg-snowy', 'bg-breeze', 'bg-mist', 'bg-haze');
            // åŒæ­¥ç§»é™¤èŠå¤©æ¶ˆæ¯åŒºåŸŸçš„å¤©æ°”èƒŒæ™¯ç±»
            chatMessages.classList.remove('bg-sunny', 'bg-cloudy', 'bg-overcast', 'bg-rainy', 'bg-snowy', 'bg-breeze', 'bg-mist', 'bg-haze');
            chatMessages.classList.remove('bg-sunny', 'bg-cloudy', 'bg-overcast', 'bg-rainy', 'bg-snowy');
            });
            
            // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
        function addMessage(data) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯@å¬éŸ³ä¹æŒ‡ä»¤çš„å“åº”
            const isMusicCommand = data.message && (data.message.includes('@å¬éŸ³ä¹') || data.message.includes('æ­£åœ¨æ’­æ”¾'));
            
            // å¦‚æœæ˜¯@å¬éŸ³ä¹æŒ‡ä»¤ï¼Œè®¾ç½®showMusicCardä¸ºtrue
            if (isMusicCommand) {
                showMusicCard = true;
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯é‡å¤çš„éŸ³ä¹æ’­æ”¾æŒ‡ä»¤
            if (isMusicCommand && isPlaying && currentAudioElement) {
                // å¦‚æœæ­£åœ¨æ’­æ”¾éŸ³ä¹ï¼Œä¸”æ˜¯é‡å¤è§¦å‘@å¬éŸ³ä¹æŒ‡ä»¤ï¼Œç»™å‡ºæç¤º
                if (data.type === 'ai_assistant' && data.message.includes('@å¬éŸ³ä¹')) {
                    // æ·»åŠ æç¤ºæ¶ˆæ¯ï¼Œä¸é‡å¤æ‰§è¡Œæ’­æ”¾æ“ä½œ
                    const hintDiv = document.createElement('div');
                    hintDiv.className = 'message ai-assistant';
                    hintDiv.innerHTML = `
                        <div class="message-content">
                            <p>ğŸµ å½“å‰å·²æœ‰éŸ³ä¹åœ¨æ’­æ”¾ä¸­ï¼Œæ— éœ€é‡å¤è§¦å‘æŒ‡ä»¤</p>
                        </div>
                    `;
                    chatMessages.appendChild(hintDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    return; // ä¸æ‰§è¡Œåç»­çš„æ¶ˆæ¯æ·»åŠ 
                }
            }
            
            const messageDiv = document.createElement('div');
            const isOwn = data.nickname === nickname;
            const isAiAssistant = data.type === 'ai_assistant';
            
            // è®¾ç½®æ¶ˆæ¯æ ·å¼ç±»
            let messageClass = 'message ';
            if (isOwn) {
                messageClass += 'own';
            } else if (isAiAssistant) {
                messageClass += 'ai-assistant';
            } else {
                messageClass += 'other';
            }
            
            // å¦‚æœæ˜¯å¤©æ°”æ¶ˆæ¯ï¼Œæ·»åŠ å¤©æ°”èƒŒæ™¯ç±»
            if (data.weather_class) {
                messageClass += ` ${data.weather_class}`;
            }
            
            messageDiv.className = messageClass;
            
            // æ ¼å¼åŒ–æ—¶é—´
            const time = new Date(data.timestamp).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            
            let messageHTML = '';
            
            // å·å°å†œAIåŠ©æ‰‹æ˜¾ç¤ºå¤´åƒ
             if (isAiAssistant && data.avatar) {
                 messageHTML += `<div class="avatar">${data.avatar}</div>`;
             }
            
            // æ·»åŠ å…ƒæ•°æ®
            messageHTML += `
                <div class="metadata">
                    ${isOwn ? 'æˆ‘' : data.nickname} Â· ${time}
                </div>
            `;
            
            // æ™®é€šæ–‡æœ¬æ¶ˆæ¯ï¼ˆç”µå½±æ¶ˆæ¯ä¹Ÿæ˜¯HTMLæ ¼å¼ï¼Œç›´æ¥æ˜¾ç¤ºï¼‰
            messageHTML += `
                <div class="content">
                    ${data.message}
                </div>
            `;
            
            messageDiv.innerHTML = messageHTML;
            chatMessages.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
            
            // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
            function addSystemMessage(message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message system';
                messageDiv.innerHTML = `<div class="content">${message}</div>`;
                chatMessages.appendChild(messageDiv);
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
            function updateUsersList(users) {
                // ä¿®å¤é”™è¯¯1ï¼šæ·»åŠ å…ƒç´ å­˜åœ¨æ€§æ£€æŸ¥ï¼Œé¿å…Cannot set properties of null (setting 'innerHTML')
                if (!usersList) {
                    console.error('usersListå…ƒç´ æœªæ‰¾åˆ°');
                    return;
                }
                
                usersList.innerHTML = '';
                
                // ç»Ÿè®¡åœ¨çº¿ç”¨æˆ·æ•°é‡
                const onlineUsers = users.filter(user => user.status === 'online');
                const onlineUserCount = document.getElementById('onlineUserCount');
                // ä¿®å¤é”™è¯¯1ï¼šæ·»åŠ å…ƒç´ å­˜åœ¨æ€§æ£€æŸ¥
                if (onlineUserCount) {
                    onlineUserCount.textContent = onlineUsers.length;
                }
                
                users.forEach(user => {
                    const userItem = document.createElement('div');
                    userItem.className = `user-item ${user.nickname === nickname ? 'you' : ''}`;
                    
                    // è·å–ç”¨æˆ·å¤´åƒé¦–å­—æ¯
                    const initial = user.nickname.charAt(0).toUpperCase();
                    
                    userItem.innerHTML = `
                        <div class="user-avatar">${initial}</div>
                        <span class="user-name">${user.nickname}${user.nickname === nickname ? ' (æˆ‘)' : ''}</span>
                        <div class="status-indicator ${user.status}"></div>
                    `;
                    
                    usersList.appendChild(userItem);
                });
            }
            
            // æ›´æ–°éŸ³ä¹æ’­æ”¾å™¨
            function updateMusicPlayer(musicData) {
                // æ¸…ç†æ—§çš„éŸ³é¢‘èµ„æº
                if (currentAudioElement) {
                    try {
                        currentAudioElement.pause();
                        currentAudioElement.src = '';
                        currentAudioElement.load();
                    } catch (error) {
                        console.error('æ¸…ç†æ—§éŸ³é¢‘èµ„æºå¤±è´¥:', error);
                    }
                    currentAudioElement = null;
                }
                isPlaying = false;
                
                // ç§»é™¤æ—§çš„éŸ³ä¹æ’­æ”¾å™¨
                const oldMusicPlayer = document.querySelector('.music-player');
                if (oldMusicPlayer) {
                    oldMusicPlayer.remove();
                }
                
                if (musicData.error) {
                    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯å¡ç‰‡ï¼Œä¸æ­£å¸¸éŸ³ä¹å¡ç‰‡æ ·å¼ç»Ÿä¸€
                    const musicPlayer = document.createElement('div');
                    musicPlayer.className = 'music-player';
                    musicPlayer.innerHTML = `
                        <div class="music-info">
                            <div class="music-header">
                                <h3>éŸ³ä¹æ’­æ”¾å¤±è´¥</h3>
                                <button class="music-close" id="closeMusicBtn">&times;</button>
                            </div>
                            <div class="music-cover">
                                <div class="cover-placeholder">âŒ</div>
                            </div>
                            <div class="error-message">
                                ${musicData.error}
                            </div>
                            <div class="music-controls">
                                <button id="retryMusicBtn" class="music-btn retry-btn">ğŸ”„ é‡è¯•</button>
                            </div>
                        </div>
                    `;
                    
                    // å°†éŸ³ä¹æ’­æ”¾å™¨æ·»åŠ åˆ°ç”¨æˆ·ä¾§è¾¹æ 
                    const usersSidebar = document.getElementById('usersSidebar');
                    if (usersSidebar) {
                        // æ·»åŠ åˆ°ç”¨æˆ·ä¾§è¾¹æ çš„é¡¶éƒ¨
                        const firstChild = usersSidebar.firstElementChild;
                        usersSidebar.insertBefore(musicPlayer, firstChild.nextSibling);
                    }
                    
                    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                    setTimeout(() => {
                        const closeBtn = document.getElementById('closeMusicBtn');
                        const retryBtn = document.getElementById('retryMusicBtn');
                        
                        // å…³é—­éŸ³ä¹æ’­æ”¾å™¨
                        if (closeBtn) {
                            closeBtn.addEventListener('click', () => {
                                musicPlayer.remove();
                            });
                        }
                        
                        // é‡è¯•åŠŸèƒ½
                        if (retryBtn) {
                            retryBtn.addEventListener('click', () => {
                                // å‘é€@å¬éŸ³ä¹å‘½ä»¤é‡æ–°è¯·æ±‚
                                if (socket) {
                                    socket.emit('message', '@å¬éŸ³ä¹');
                                }
                            });
                        }
                    }, 100);
                } else if (musicData.title) {
                    // åˆ›å»ºéŸ³ä¹æ’­æ”¾å™¨å…ƒç´ 
                    const musicPlayer = document.createElement('div');
                    musicPlayer.className = 'music-player';
                    musicPlayer.innerHTML = `
                        <div class="music-info">
                            <div class="music-header">
                                <h3>${musicData.title}</h3>
                                <p class="artist">${musicData.artist}</p>
                                <button class="music-close" id="closeMusicBtn">&times;</button>
                            </div>
                            <div class="music-cover">
                                <div class="cover-placeholder">ğŸµ</div>
                            </div>
                            <div class="music-progress">
                                <div class="progress-bar" id="progressBar">
                                    <div class="progress-fill" id="progressFill"></div>
                                </div>
                                <div class="progress-time">
                                    <span id="currentTime">0:00</span>
                                    <span id="duration">0:00</span>
                                </div>
                            </div>
                            <div class="music-controls">
                                <button id="stopBtn" class="music-btn stop-btn">â¹ï¸ åœæ­¢</button>
                                <button id="playBtn" class="music-btn play-btn">â–¶ï¸ æ’­æ”¾</button>
                                <button id="pauseBtn" class="music-btn pause-btn" style="display: none;">â¸ï¸ æš‚åœ</button>
                            </div>
                            <!-- ä¿®å¤é”™è¯¯2ï¼šæ·»åŠ å¤šç§æ ¼å¼æ”¯æŒ -->
                            <audio id="currentAudio" preload="metadata">
                                <!-- ä¸»éŸ³é¢‘æºå°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
                            </audio>
                        </div>
                    `;
                    
                    // ä¿®å¤é”™è¯¯2ï¼šæ·»åŠ éŸ³é¢‘åŠ è½½é”™è¯¯å¤„ç†å’Œå¤šç§æ ¼å¼æ”¯æŒ
                    const audio = musicPlayer.querySelector('#currentAudio');
                    if (audio) {
                        // æ¸…ç©ºç°æœ‰éŸ³é¢‘æº
                        while (audio.firstChild) {
                            audio.removeChild(audio.firstChild);
                        }
                        
                        // æ·»åŠ éŸ³é¢‘æº - åªæ·»åŠ MP3æ ¼å¼ï¼Œé¿å…åŠ è½½ä¸å­˜åœ¨çš„æ–‡ä»¶
                        if (musicData.url) {
                            // åªæ·»åŠ MP3æºï¼Œç¡®ä¿æ–‡ä»¶å­˜åœ¨
                            const mp3Source = document.createElement('source');
                            mp3Source.src = musicData.url;
                            mp3Source.type = 'audio/mpeg';
                            audio.appendChild(mp3Source);
                        }
                        
                        // æ·»åŠ é”™è¯¯äº‹ä»¶ç›‘å¬
                        audio.addEventListener('error', function(e) {
                            console.error('éŸ³é¢‘åŠ è½½é”™è¯¯:', e);
                            
                            // éšè—æ’­æ”¾/æš‚åœæŒ‰é’®ï¼Œæ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                            const playBtn = musicPlayer.querySelector('#playBtn');
                            const pauseBtn = musicPlayer.querySelector('#pauseBtn');
                            if (playBtn) playBtn.style.display = 'none';
                            if (pauseBtn) pauseBtn.style.display = 'none';
                            
                            // æ˜¾ç¤ºä½¿ç”¨æœ¬åœ°éŸ³ä¹çš„é€‰é¡¹
                            const musicControls = musicPlayer.querySelector('.music-controls');
                            if (musicControls) {
                                // æ¸…ç©ºç°æœ‰æ§åˆ¶æŒ‰é’®
                                musicControls.innerHTML = '';
                                
                                // æ·»åŠ ä½¿ç”¨æœ¬åœ°éŸ³ä¹æŒ‰é’®
                                const useLocalBtn = document.createElement('button');
                                useLocalBtn.id = 'useLocalMusicBtn';
                                useLocalBtn.className = 'music-btn local-btn';
                                useLocalBtn.textContent = 'ğŸµ ä½¿ç”¨æœ¬åœ°éŸ³ä¹';
                                useLocalBtn.addEventListener('click', () => {
                                    // å‘é€@éŸ³ä¹å‘½ä»¤ä½¿ç”¨æœ¬åœ°éŸ³ä¹
                                    if (socket) {
                                        socket.emit('message', '@éŸ³ä¹');
                                    }
                                });
                                musicControls.appendChild(useLocalBtn);
                                
                                // æ·»åŠ é‡è¯•æŒ‰é’®
                                const retryBtn = document.createElement('button');
                                retryBtn.id = 'retryMusicBtn';
                                retryBtn.className = 'music-btn retry-btn';
                                retryBtn.textContent = 'ğŸ”„ é‡è¯•';
                                retryBtn.addEventListener('click', () => {
                                    // é‡æ–°å‘é€@å¬éŸ³ä¹å‘½ä»¤
                                    if (socket) {
                                        socket.emit('message', '@å¬éŸ³ä¹');
                                    }
                                });
                                musicControls.appendChild(retryBtn);
                            }
                            
                            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                            let errorMsg = musicPlayer.querySelector('.audio-error');
                            if (!errorMsg) {
                                errorMsg = document.createElement('div');
                                errorMsg.className = 'audio-error';
                                errorMsg.style.color = 'red';
                                errorMsg.style.fontSize = '12px';
                                errorMsg.style.marginTop = '8px';
                                musicPlayer.querySelector('.music-info').appendChild(errorMsg);
                            }
                            
                            // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒçš„é”™è¯¯ä¿¡æ¯
                            let errorText = 'éŸ³é¢‘åŠ è½½å¤±è´¥';
                            if (e.target.error.code === e.target.error.NETWORK_ERR) {
                                errorText = 'ç½‘ç»œè¿æ¥é”™è¯¯ï¼Œæ— æ³•åŠ è½½éŸ³é¢‘æ–‡ä»¶';
                            } else if (e.target.error.code === e.target.error.MEDIA_ERR_SRC_NOT_SUPPORTED) {
                                errorText = 'éŸ³é¢‘æ ¼å¼ä¸æ”¯æŒæˆ–URLæ— æ•ˆ';
                            } else {
                                errorText = 'éŸ³é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–å°è¯•å…¶ä»–æ­Œæ›²';
                            }
                            errorMsg.textContent = errorText;
                        });
                    }
                    
                    // å°†éŸ³ä¹æ’­æ”¾å™¨æ·»åŠ åˆ°ç”¨æˆ·ä¾§è¾¹æ 
                    const usersSidebar = document.getElementById('usersSidebar');
                    if (usersSidebar) {
                        // æ·»åŠ åˆ°ç”¨æˆ·ä¾§è¾¹æ çš„é¡¶éƒ¨
                        const firstChild = usersSidebar.firstElementChild;
                        usersSidebar.insertBefore(musicPlayer, firstChild.nextSibling);
                    }
                    
                    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                    setTimeout(() => {
                        const playBtn = document.getElementById('playBtn');
                        const pauseBtn = document.getElementById('pauseBtn');
                        const stopBtn = document.getElementById('stopBtn');
                        const closeBtn = document.getElementById('closeMusicBtn');
                        const audio = document.getElementById('currentAudio');
                        const progressBar = document.getElementById('progressBar');
                        const progressFill = document.getElementById('progressFill');
                        const currentTimeEl = document.getElementById('currentTime');
                        const durationEl = document.getElementById('duration');
                        
                        // æ ¼å¼åŒ–æ—¶é—´å‡½æ•°
                        function formatTime(seconds) {
                            const mins = Math.floor(seconds / 60);
                            const secs = Math.floor(seconds % 60);
                            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
                        }
                        
                        // æ›´æ–°å½“å‰éŸ³é¢‘å…ƒç´ å¼•ç”¨
                            currentAudioElement = audio;
                            
                            // æ’­æ”¾éŸ³ä¹
                            if (playBtn) {
                                playBtn.addEventListener('click', () => {
                                    if (audio && !isPlaying) {
                                        isPlaying = true;
                                        audio.play().then(() => {
                                            playBtn.style.display = 'none';
                                            pauseBtn.style.display = 'inline-block';
                                        }).catch(error => {
                                            console.error('æ’­æ”¾å¤±è´¥:', error);
                                            isPlaying = false;
                                        });
                                        // é€šçŸ¥æœåŠ¡å™¨
                                        if (socket) {
                                            socket.emit('music_control', { action: 'play' });
                                        }
                                    }
                                });
                            }
                        
                        // æš‚åœéŸ³ä¹
                        if (pauseBtn) {
                            pauseBtn.addEventListener('click', () => {
                                if (audio && isPlaying) {
                                    isPlaying = false;
                                    audio.pause();
                                    pauseBtn.style.display = 'none';
                                    playBtn.style.display = 'inline-block';
                                    // é€šçŸ¥æœåŠ¡å™¨
                                    if (socket) {
                                        socket.emit('music_control', { action: 'pause' });
                                    }
                                }
                            });
                        }
                        
                        // åœæ­¢éŸ³ä¹
                        if (stopBtn) {
                            stopBtn.addEventListener('click', () => {
                                if (audio) {
                                    audio.pause();
                                    audio.currentTime = 0;
                                    if (progressFill) {
                                        progressFill.style.width = '0%';
                                    }
                                    if (currentTimeEl) {
                                        currentTimeEl.textContent = '0:00';
                                    }
                                    pauseBtn.style.display = 'none';
                                    playBtn.style.display = 'inline-block';
                                }
                                // é€šçŸ¥æœåŠ¡å™¨
                                if (socket) {
                                    socket.emit('music_control', { action: 'stop' });
                                }
                            });
                        }
                        
                        // å…³é—­éŸ³ä¹æ’­æ”¾å™¨
                        if (closeBtn) {
                            closeBtn.addEventListener('click', () => {
                                if (audio) {
                                    audio.pause();
                                    audio.currentTime = 0;
                                }
                                musicPlayer.remove();
                                // é€šçŸ¥æœåŠ¡å™¨
                                if (socket) {
                                    socket.emit('music_control', { action: 'stop' });
                                }
                            });
                        }
                        
                        // æ›´æ–°è¿›åº¦æ¡
                        function updateProgress(currentTime, duration) {
                            if (duration > 0) {
                                const progress = (currentTime / duration) * 100;
                                progressFill.style.width = `${progress}%`;
                                currentTimeEl.textContent = formatTime(currentTime);
                                durationEl.textContent = formatTime(duration);
                            }
                        }
                        
                        // åˆå§‹åŒ–æ­Œè¯
                        const lyrics = musicData.lyrics || [];
                        let currentLyricIndex = 0;
                        const lyricsContainer = document.getElementById('lyricsContainer');
                        
                        // æ¸²æŸ“æ­Œè¯ - ä¿®å¤é”™è¯¯ï¼šæ·»åŠ å…ƒç´ å­˜åœ¨æ€§æ£€æŸ¥
                        if (lyricsContainer) {
                            if (lyrics.length > 0) {
                                lyricsContainer.innerHTML = lyrics.map(lyric => `<div class="lyric">${lyric.text}</div>`).join('');
                            } else {
                                lyricsContainer.innerHTML = '<div class="lyric">æš‚æ— æ­Œè¯</div>';
                            }
                        }
                        
                        // æ›´æ–°å½“å‰æ˜¾ç¤ºçš„æ­Œè¯
                        function updateLyrics(currentTime) {
                            if (lyrics.length === 0) return;
                            
                            // æ‰¾åˆ°å½“å‰æ—¶é—´å¯¹åº”çš„æ­Œè¯
                            let newIndex = 0;
                            for (let i = 0; i < lyrics.length; i++) {
                                if (lyrics[i].time <= currentTime) {
                                    newIndex = i;
                                } else {
                                    break;
                                }
                            }
                            
                            if (newIndex !== currentLyricIndex) {
                                // ç§»é™¤ä¹‹å‰çš„é«˜äº®
                                const prevLyric = lyricsContainer.children[currentLyricIndex];
                                if (prevLyric) prevLyric.classList.remove('active');
                                
                                // æ·»åŠ æ–°çš„é«˜äº®
                                const currentLyric = lyricsContainer.children[newIndex];
                                if (currentLyric) {
                                    currentLyric.classList.add('active');
                                    // æ»šåŠ¨åˆ°å½“å‰æ­Œè¯
                                    currentLyric.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                                
                                currentLyricIndex = newIndex;
                            }
                        }
                        
                        // éŸ³é¢‘æ—¶é—´æ›´æ–°äº‹ä»¶
                        if (audio) {
                            audio.addEventListener('timeupdate', () => {
                                updateProgress(audio.currentTime, audio.duration);
                                updateLyrics(audio.currentTime);
                            });
                            
                            // éŸ³é¢‘åŠ è½½å®Œæˆäº‹ä»¶
                            audio.addEventListener('loadedmetadata', () => {
                                durationEl.textContent = formatTime(audio.duration);
                            });
                            
                            // éŸ³é¢‘æ’­æ”¾ç»“æŸäº‹ä»¶
                            audio.addEventListener('ended', () => {
                                audio.currentTime = 0;
                                pauseBtn.style.display = 'none';
                                playBtn.style.display = 'inline-block';
                            });
                            
                            // ç‚¹å‡»è¿›åº¦æ¡è°ƒæ•´æ’­æ”¾ä½ç½®
                            progressBar.addEventListener('click', (e) => {
                                if (audio && audio.duration) {
                                    const rect = progressBar.getBoundingClientRect();
                                    const clickX = e.clientX - rect.left;
                                    const percentage = clickX / rect.width;
                                    audio.currentTime = percentage * audio.duration;
                                    updateProgress(audio.currentTime, audio.duration);
                                }
                            });
                        }
                        
                        // æ ¹æ®éŸ³ä¹çŠ¶æ€æ§åˆ¶æŒ‰é’®æ˜¾ç¤º
                        if (musicData.status === 'playing') {
                            playBtn.style.display = 'none';
                            pauseBtn.style.display = 'inline-block';
                            if (audio) {
                                audio.play().catch(error => {
                                    console.error('è‡ªåŠ¨æ’­æ”¾å¤±è´¥:', error);
                                });
                            }
                        } else if (musicData.status === 'paused') {
                            pauseBtn.style.display = 'none';
                            playBtn.style.display = 'inline-block';
                        } else if (musicData.status === 'stopped') {
                            pauseBtn.style.display = 'none';
                            playBtn.style.display = 'inline-block';
                        }
                    }, 100);
                }
            }
            
            // æ ¼å¼åŒ–æ—¶é—´
            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }
            
            // å…³é—­éŸ³ä¹æ’­æ”¾å™¨
            function closeMusic() {
                try {
                    const musicPlayer = document.querySelector('.music-player');
                    const audio = document.getElementById('currentAudio');
                    
                    if (audio) {
                        audio.pause();
                        audio.currentTime = 0;
                    }
                    
                    if (musicPlayer) {
                        musicPlayer.remove(); // ç›´æ¥ç§»é™¤æ•´ä¸ªæ’­æ”¾å™¨
                    }
                    
                    // é€šçŸ¥æœåŠ¡å™¨åœæ­¢éŸ³ä¹
                    if (socket) {
                        socket.emit('music_control', { action: 'stop' });
                    }
                } catch (error) {
                    console.error('å…³é—­éŸ³ä¹æ’­æ”¾å™¨æ—¶å‡ºé”™:', error);
                }
            }
            
            // éŸ³ä¹æ’­æ”¾ç›¸å…³å‡½æ•°
            let currentAudio = null;
            
            // æ’­æ”¾éŸ³ä¹
            function playMusic(url) {
                if (!currentAudio) {
                    currentAudio = new Audio();
                }
                currentAudio.src = url;
                currentAudio.play();
            }
            
            // æš‚åœéŸ³ä¹
            function pauseMusic() {
                if (currentAudio) {
                    currentAudio.pause();
                }
            }
            
            // åœæ­¢éŸ³ä¹
            function stopMusic() {
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                }
            }
            
            // å…³é—­éŸ³ä¹å¡ç‰‡
            function closeMusicCard() {
                // è·å–æœ€è¿‘çš„éŸ³ä¹å¡ç‰‡å…ƒç´ 
                const musicCard = event.target.closest('div[style*="display: flex; align-items: center;"]');
                if (musicCard) {
                    stopMusic();
                    musicCard.remove();
                }
            }
            
            // å‘é€æ¶ˆæ¯
            function sendMessage() {
                const message = messageInput.value.trim();
                if (message && socket) {
                    const timestamp = new Date().toISOString();
                    
                    socket.emit('send_message', {
                        nickname: nickname,
                        message: message,
                        timestamp: timestamp
                    });
                    
                    messageInput.value = '';
                    // é‡ç½®textareaé«˜åº¦
                    messageInput.style.height = 'auto';
                    
                    // éšè—@é€‰é¡¹
                    hideAtOptions();
                    lastAtPosition = -1;
                }
            }
            
            // æ˜¾ç¤ºæç¤º
            function showTip(message) {
                const tip = document.createElement('div');
                tip.className = 'tip';
                tip.textContent = message;
                document.body.appendChild(tip);
                
                setTimeout(() => {
                    tip.remove();
                }, 3000);
            }
            
            // åˆå§‹åŒ–emojié€‰æ‹©å™¨
            function initEmojiPicker() {
                const emojis = ['ğŸ˜Š', 'ğŸ˜‚', 'ğŸ˜', 'ğŸ¤”', 'ğŸ˜', 'ğŸ˜¢', 'ğŸ˜¡', 'ğŸ‘', 'ğŸ‘', 'â¤ï¸', 'ğŸ‰', 'ğŸ”¥', 'ğŸ™', 'ğŸ¤£', 'ğŸ¥°', 'ğŸ˜±', 'ğŸ¤—', 'ğŸ˜´', 'ğŸ˜˜', 'ğŸ¤©', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ˜†', 'ğŸ™„', 'ğŸ˜…', 'ğŸ˜‰', 'ğŸ¤—', 'ğŸ˜‹', 'ğŸ˜œ', 'ğŸ¥³'];
                
                emojis.forEach(emoji => {
                    const emojiEl = document.createElement('div');
                    emojiEl.className = 'emoji';
                    emojiEl.textContent = emoji;
                    emojiEl.addEventListener('click', function() {
                        messageInput.value += emoji;
                        messageInput.focus();
                    });
                    emojiPicker.appendChild(emojiEl);
                });
            }
            
            // ç›‘å¬è¾“å…¥äº‹ä»¶ï¼Œè‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦å’Œå¤„ç†@åŠŸèƒ½
            messageInput.addEventListener('input', function(e) {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                
                // å¤„ç†@åŠŸèƒ½
                const text = this.value;
                const cursorPos = this.selectionStart;
                const lastAtIndex = text.lastIndexOf('@', cursorPos - 1);
                
                // æ£€æŸ¥æ˜¯å¦è¾“å…¥äº†@ç¬¦å·ä¸”åé¢æ²¡æœ‰å…¶ä»–å­—ç¬¦
                if (lastAtIndex !== -1 && lastAtIndex === cursorPos - 1) {
                    // æ˜¾ç¤º@é€‰é¡¹
                    showAtOptions(this, cursorPos);
                    lastAtPosition = lastAtIndex;
                } else if (lastAtPosition !== -1 && cursorPos <= lastAtPosition) {
                    // å…‰æ ‡å›åˆ°@ç¬¦å·ä¹‹å‰ï¼Œéšè—é€‰é¡¹
                    hideAtOptions();
                    lastAtPosition = -1;
                }
            });
            
            // æ˜¾ç¤º@é€‰é¡¹
            function showAtOptions(input, cursorPos) {
                const rect = input.getBoundingClientRect();
                const inputTop = rect.top + window.scrollY;
                const inputLeft = rect.left + window.scrollX;
                const inputHeight = rect.height;
                
                // è®¡ç®—@ç¬¦å·çš„ä½ç½®
                const textBeforeCursor = input.value.substring(0, cursorPos);
                const lineHeight = parseFloat(getComputedStyle(input).lineHeight);
                const linesBeforeCursor = Math.ceil((input.scrollTop + cursorPos * 8) / lineHeight);
                
                atOptions.style.top = (inputTop + inputHeight) + 'px';
                atOptions.style.left = inputLeft + 'px';
                atOptions.classList.add('visible');
            }
            
            // éšè—@é€‰é¡¹
            function hideAtOptions() {
                atOptions.classList.remove('visible');
            }
            
            // ç‚¹å‡»@é€‰é¡¹
            atOptions.addEventListener('click', function(e) {
                if (e.target.classList.contains('at-option')) {
                    const action = e.target.getAttribute('data-action');
                    insertAtAction(action);
                    hideAtOptions();
                }
            });
            
            // æ’å…¥@åŠ¨ä½œåˆ°è¾“å…¥æ¡†
            function insertAtAction(action) {
                const input = messageInput;
                const start = input.selectionStart;
                const end = input.selectionEnd;
                
                // æ›¿æ¢@ç¬¦å·ä¸ºå®Œæ•´çš„@åŠ¨ä½œ
                const text = input.value;
                const newText = text.substring(0, lastAtPosition) + '@' + action + ' ' + text.substring(end);
                
                input.value = newText;
                lastAtPosition = -1;
                
                // å°†å…‰æ ‡ç§»åŠ¨åˆ°@åŠ¨ä½œåé¢
                const newCursorPos = lastAtPosition + action.length + 2;
                input.setSelectionRange(newCursorPos, newCursorPos);
                input.focus();
                
                // è°ƒæ•´textareaé«˜åº¦
                input.style.height = 'auto';
                input.style.height = Math.min(input.scrollHeight, 120) + 'px';
            }
            
            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­@é€‰é¡¹
            document.addEventListener('click', function(e) {
                if (!messageInput.contains(e.target) && !atOptions.contains(e.target)) {
                    hideAtOptions();
                    lastAtPosition = -1;
                }
            });
            
            // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            sendBtn.addEventListener('click', sendMessage);
            
            // å›è½¦é”®å‘é€æ¶ˆæ¯
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // é€€å‡ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            logoutBtn.addEventListener('click', function() {
                if (socket) {
                    socket.disconnect();
                }
                window.location.href = '/';
            });
            
            // åˆ‡æ¢emojié€‰æ‹©å™¨
            toggleEmojiBtn.addEventListener('click', function() {
                emojiPicker.classList.toggle('visible');
            });
            
            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­emojié€‰æ‹©å™¨
            document.addEventListener('click', function(e) {
                if (!toggleEmojiBtn.contains(e.target) && !emojiPicker.contains(e.target)) {
                    emojiPicker.classList.remove('visible');
                }
            });
            
            // ç§»åŠ¨ç«¯åˆ‡æ¢ä¾§è¾¹æ 
            toggleSidebarBtn.addEventListener('click', function() {
                usersSidebar.classList.toggle('visible');
            });
            
            // åˆå§‹åŒ–
            initWebSocket();
            initEmojiPicker();
            
            // æ˜¾ç¤ºä½¿ç”¨æç¤º
            setTimeout(() => {
                showTip('æç¤ºï¼šè¾“å…¥@ç¬¦å·å¯é€‰æ‹©å¤©æ°”ã€æ–°é—»ã€å¬éŸ³ä¹åŠŸèƒ½ï¼Œè¾“å…¥å®Œæ•´å‘½ä»¤åå‘é€å³å¯è§¦å‘å¯¹åº”åŠŸèƒ½');
            }, 1000);
        });
    </script>
</body>
</html>