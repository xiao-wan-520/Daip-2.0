# 天气功能使用说明

## 1. 依赖库安装

请在项目根目录下执行以下命令安装所需依赖：

```bash
pip install requests
```

## 2. API密钥配置

### 2.1 获取API密钥

1. 访问 [和风天气开发者平台](https://dev.qweather.com/)
2. 注册账号并登录
3. 点击「控制台」→「创建应用」
4. 填写应用名称，选择「免费开发者」套餐
5. 创建成功后，在应用详情页获取API密钥（KEY）

### 2.2 配置API密钥

在 `app.py` 文件中找到 `WEATHER_API_KEY` 变量，将其值替换为您的API密钥：

```python
WEATHER_API_KEY = 'your_actual_api_key'  # 替换为您的真实API密钥
```

**注意：** 必须替换默认值为真实密钥，否则天气功能无法正常使用。

## 3. 背景图片资源

当前天气背景使用CSS渐变和纹理实现，无需额外图片资源。

如果您想要自定义背景图片：
1. 将背景图片文件放置在`static/images/weather/`目录下
2. 修改`app.py`中的`WEATHER_BACKGROUND_MAP`，将对应天气类型的`class`属性改为自定义类名
3. 在`chat.html`中添加对应类名的CSS样式，指定背景图片路径

## 4. 功能说明

### 4.1 基本使用

在聊天框中输入以下格式的命令获取天气信息：

**格式1：**
```
@天气 城市名
```

**格式2：**
```
@天气+城市名
```

例如：
```
@天气 北京
@天气+上海
```

系统会返回该城市的实时天气信息，包括：
- 天气状况（晴、多云、阴等）
- 温度
- 湿度
- 风向风力
- 更新时间

### 4.2 背景自动切换

根据天气类型，聊天背景会自动切换：
- 晴：浅蓝色清爽背景
- 多云：浅灰色背景
- 阴：深灰色背景
- 雨：浅蓝色带细微雨滴纹理背景
- 雪：浅白色带雪花纹理背景

### 4.3 恢复默认背景

点击聊天界面右上角的「🖼️」按钮，可以恢复默认背景。

### 4.4 缓存机制

10分钟内同一城市的天气查询会直接使用缓存数据，减少API调用次数。

## 5. 配置参数

在 `app.py` 文件中，您可以调整以下天气相关配置参数：

| 参数名 | 描述 | 默认值 |
| --- | --- | --- |
| WEATHER_API_KEY | 和风天气API密钥 | - |
| WEATHER_CACHE_EXPIRE | 缓存过期时间（秒） | 600（10分钟） |
| WEATHER_BACKGROUND_MAP | 天气与背景的映射关系 | 见代码 |
| WEATHER_EMOJI | 天气类型对应的emoji | 见代码 |

## 6. 故障排除

### 6.1 常见问题

1. **问题：** 输入@天气命令后显示「天气功能未配置，请联系管理员设置和风天气API密钥」
   **解决方法：** 请按照步骤2配置真实的和风天气API密钥

2. **问题：** 输入@天气命令后显示「未查询到该城市天气，请检查地名是否正确」
   **解决方法：** 
   - 确保城市名拼写正确
   - 尝试使用更具体的城市名（如「成都」而不是「四川」）
   - 检查网络连接是否正常
   - 查看控制台日志，确认API调用是否成功

3. **问题：** 天气背景未自动切换
   **解决方法：** 
   - 检查CSS样式是否正确配置
   - 查看浏览器控制台是否有错误信息
   - 确认`WEATHER_BACKGROUND_MAP`配置正确

### 6.2 查看日志

服务器启动后，会输出详细的日志信息，包括：
- API请求URL和响应状态
- API响应数据
- 错误信息和调试日志

通过查看这些日志，您可以了解天气功能的运行状态和可能的错误原因。

## 7. 注意事项

1. 免费版API有调用次数限制（每天1000次），请合理使用
2. 天气数据缓存10分钟，避免频繁调用API
3. 确保网络连接正常，能够访问和风天气API（https://devapi.qweather.com 和 https://geoapi.qweather.com）
4. 定期检查API密钥是否有效，避免因密钥过期导致功能失效
5. 在生产环境中，建议将API密钥存储在环境变量或配置文件中，避免硬编码在代码中
